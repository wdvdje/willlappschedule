<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#4a90e2" />
  <link rel="manifest" href="manifest.json" />
  <title>TimeScape Planner</title>
  <style>
    /* filepath: /Users/williamjoyce/Documents/GitHub/willlappschedule/assets/app.css (inlined) */
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; text-align:center; }
    header { background:#4a90e2; color:#fff; padding:1rem; font-size:1.25rem; position:sticky; top:0; z-index:50 }
    main{padding-bottom:92px;}
    .hidden{display:none}
    .page{max-width:900px;margin:12px auto;padding:0 12px;box-sizing:border-box;text-align:left}
    .calendar-controls{display:flex;gap:10px;justify-content:center;align-items:center;margin:18px 0;}
    .calendar-controls button{background:#4a90e2;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:10px;width:calc(100vw - 32px);max-width:100%;margin:0 auto 12px;background:#fff;border-radius:10px;box-shadow:0 1px 8px rgba(0,0,0,0.07);box-sizing:border-box;}
    .calendar-dayname{font-weight:700;color:#4a90e2;padding-bottom:4px}
    .day{background:#fff;border-radius:8px;padding:8px;min-height:64px;position:relative;cursor:pointer;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.06); display:flex; flex-direction:column; align-items:stretch;}
    .day.selected{border:2px solid #4a90e2;box-shadow:0 2px 8px rgba(74,144,226,0.15)}
    .day.today{outline:2px solid #4a90e2;}
    .day .day-number{font-weight:700;display:flex;gap:6px;align-items:center;justify-content:flex-start}
    .emoji-row{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;padding-top:6px;flex:1 1 auto;min-height:18px;max-height:48px;box-sizing:border-box}
    .event-preview{display:inline-flex;align-items:center;justify-content:center;line-height:1;border-radius:6px;padding:2px;background:transparent;user-select:none}
    .reminder-dot{width:8px;height:8px;border-radius:50%;background:#e67e22;display:inline-block;margin-left:6px}
    .reminder-bar{background:#fbeee6;border-left:4px solid #e67e22;color:#9a6b16;margin:8px 0;padding:8px;border-radius:6px;font-size:0.95rem;text-align:left}
    .reminder-bar .events-list{ margin:6px 0 0 0; padding:0; }
    .reminder-bar .r-event{ padding:4px 0; margin:0; display:flex; gap:8px; align-items:center; font-size:0.95rem; }
    .reminder-bar .r-event b{ margin-right:4px; }
    .reminder-bar .r-actions{ margin-left:auto; }
    .item-controls{margin-left:8px}
    .small-btn{padding:4px 6px;background:#888;color:#fff;border:none;border-radius:4px;margin-left:6px;cursor:pointer}
    input[type="text"],input[type="date"],input[type="time"],select,textarea{padding:8px;border-radius:4px;border:1px solid #ccc;width:100%;box-sizing:border-box;margin-top:6px}
    .mobile-row{display:flex;gap:8px;align-items:center}
    .mobile-label{display:none;font-weight:600;margin-right:8px}
    @media (max-width:600px){ .mobile-label{display:inline-block} .calendar,.tasks,.events,.reminders{width:calc(100vw - 32px);}}
    #editModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;z-index:9999}
    #editModal .panel{background:#fff;padding:16px;border-radius:8px;max-width:520px;width:94%;box-shadow:0 6px 30px rgba(0,0,0,0.2);text-align:left}
    #editModal label{font-weight:600}
    .event-preview.reminder { color: #e67e22; } .event-preview.task { color: green; } .reminder-dot { display:none; }
    .places-suggestions { position:relative; }
    .places-suggestions .suggestions-list { position:absolute; left:0; right:0; background:#fff;border:1px solid #ddd;border-radius:6px;margin-top:6px;z-index:2000; max-height:220px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .places-suggestions .suggestions-list button{ display:block;width:100%;text-align:left;padding:8px 10px;border:0;background:transparent;cursor:pointer; }
    .places-suggestions .suggestions-list button:hover{ background:#f2f6fb; }
    .progress { width:64px; height:64px; border-radius:50%; border:8px solid #eee; border-top:8px solid #4a90e2; display:inline-block; margin-top:8px; transition: transform 0.4s linear; box-sizing:border-box; }
    #dayProgressRing { border-top-color: #4a90e2; } #progressRing { border-top-color: #4a90e2; }
    .bottom-ribbon{ position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid #e6e6e6;display:flex;align-items:center;justify-content:space-around; box-shadow:0 -4px 18px rgba(0,0,0,0.06);z-index:999; }
    .bottom-ribbon .r-item{ text-decoration:none;color:#333;font-size:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:6px 4px;}
    .bottom-ribbon .r-item .r-label{ font-size:11px;margin-top:4px;display:block;}
    .bottom-ribbon .r-item.r-center{ background:linear-gradient(0deg, rgba(74,144,226,0.06), transparent); border-radius:12px; margin:0 6px; padding:8px 6px; }
    body { padding-bottom: 92px; }
  </style>
</head>
<body>
  <header>üìÖ TimeScape Planner</header>
  <main>
    <!-- Calendar page -->
    <section id="page-calendar" class="page">
      <div class="calendar-controls">
        <button id="prevBtn">&lt;</button>
        <span id="monthLabel" aria-live="polite"></span>
        <button id="nextBtn">&gt;</button>
      </div>

      <section id="calendar" class="calendar" role="grid" aria-label="Calendar"></section>

      <div id="selectedDateArea" style="max-width:540px;margin:0 auto 12px;padding:0 12px;box-sizing:border-box;text-align:left;">
        <h2 id="selectedDateLong" style="display:none;margin-bottom:6px"></h2>
        <div id="dayTopBars"></div>
      </div>

      <section class="dashboard">
        <h2>üìä Dashboard</h2>
        <p id="summaryStats"></p>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="progress" id="progressRing" title="Overall progress"></div>
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <div style="font-size:0.95rem;color:#444;">Selected day</div>
            <div class="progress" id="dayProgressRing" title="Selected-day progress"></div>
          </div>
        </div>
      </section>

      <div id="reminderBar" aria-live="polite" style="max-width:540px;margin:12px auto;padding:0 12px;box-sizing:border-box;text-align:left;"></div>
    </section>

    <!-- Events page -->
    <section id="page-events" class="page hidden">
      <h2>üìÖ Events</h2>
      <form id="eventForm">
        <input id="eventTitle" type="text" placeholder="Event title" required />

        <!-- Date input with overlay label -->
        <div class="overlay-input" style="margin-top:8px">
          <input id="eventDate" type="date" class="overlay-field" required />
          <span class="overlay-label">Date</span>
        </div>

        <!-- Start time input with overlay -->
        <div class="overlay-input" style="margin-top:8px;display:inline-block;width:48%;box-sizing:border-box">
          <input id="eventTime" type="time" class="overlay-field" />
          <span class="overlay-label">Start time</span>
        </div>

        <!-- End time input with overlay -->
        <div class="overlay-input" style="margin-top:8px;display:inline-block;width:48%;box-sizing:border-box;margin-left:4%">
          <input id="eventEndTime" type="time" class="overlay-field" />
          <span class="overlay-label">End time</span>
        </div>

        <div class="places-suggestions" style="margin-top:8px">
          <input id="eventLocation" type="text" placeholder="Location" autocomplete="off" autocorrect="off" autocapitalize="off" />
          <div id="eventLocationList" class="suggestions-list" style="display:none"></div>
        </div>

        <input id="eventEmoji" type="text" placeholder="Emoji (e.g. üéâ)" style="margin-top:8px;width:36%" />

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <label style="min-width:90px;margin:0">Pre-buffer</label>
          <select id="eventPreBuffer" style="width:120px">
            <option value="5">5 m</option><option value="10">10 m</option><option value="15">15 m</option>
            <option value="20">20 m</option><option value="25">25 m</option><option value="30">30 m</option>
            <option value="35">35 m</option><option value="40">40 m</option><option value="45">45 m</option>
            <option value="50">50 m</option><option value="55">55 m</option><option value="60">60 m</option>
            <option value="90">90 m</option><option value="120">120 m</option>
          </select>

          <label style="min-width:90px;margin:0">Post-buffer</label>
          <select id="eventPostBuffer" style="width:120px">
            <option value="5">5 m</option><option value="10">10 m</option><option value="15">15 m</option>
            <option value="20">20 m</option><option value="25">25 m</option><option value="30">30 m</option>
            <option value="35">35 m</option><option value="40">40 m</option><option value="45">45 m</option>
            <option value="50">50 m</option><option value="55">55 m</option><option value="60">60 m</option>
            <option value="90">90 m</option><option value="120">120 m</option>
          </select>
        </div>

        <div style="margin-top:8px"><button id="addEventBtn" type="submit">Add Event</button></div>
      </form>
      <ul id="eventList" style="margin-top:12px"></ul>
    </section>

    <!-- Reminders page -->
    <section id="page-reminders" class="page hidden">
      <h2>‚è∞ Reminders</h2>
      <div id="reminderBarPage" aria-live="polite"></div>
      <form id="reminderForm" style="margin-top:12px">
        <div class="mobile-row" style="gap:8px;align-items:center">
          <label class="mobile-label" for="reminderDate">Date</label>
          <input id="reminderDate" type="date" />
        </div>
        <div style="margin-top:8px" class="mobile-row">
          <label class="mobile-label" for="reminderInput">Reminder</label>
          <input type="text" id="reminderInput" placeholder="Add reminder..." />
        </div>
        <div style="margin-top:8px" class="mobile-row">
          <label class="mobile-label" for="reminderTime">Time</label>
          <input type="time" id="reminderTime" style="width:36%" />
          <button id="addReminderBtn" type="submit" style="width:auto;margin-left:8px">Add Reminder</button>
        </div>
      </form>
    </section>

    <!-- Tasks page -->
    <section id="page-tasks" class="page hidden">
      <h2>‚úÖ Tasks</h2>
      <form id="taskForm">
        <input id="newTask" type="text" placeholder="Add a task..." required />
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="taskCategory" style="width:40%">
            <option value="work">Work</option><option value="personal">Personal</option><option value="errands">Errands</option>
          </select>
          <input id="taskDate" type="date" style="flex:1" />
          <input id="taskTime" type="time" style="width:120px" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <select id="taskPriority" style="width:120px"><option value="1">!</option><option value="2">!!</option><option value="3">!!!</option></select>
          <button id="addTaskBtn" type="submit">Add</button>
        </div>
      </form>
      <ul id="taskList" style="margin-top:12px"></ul>
    </section>

    <!-- Settings page -->
    <section id="page-settings" class="page hidden">
      <h2>‚öôÔ∏è Settings</h2>
      <p>Placeholder ‚Äî settings will be added later.</p>
    </section>
  </main>

  <!-- Edit modal used by all pages -->
  <div id="editModal" role="dialog" aria-modal="true" class="hidden">
    <div class="panel">
      <h3 id="editModalHeading">Edit</h3>
      <form id="editForm">
        <input type="hidden" id="editKind" />
        <input type="hidden" id="editEventId" />
        <input type="hidden" id="editTaskIndex" />
        <input type="hidden" id="editReminderKey" />
        <input type="hidden" id="editReminderIndex" />
        <div style="margin-top:8px;">
          <label for="editText">Text / Title</label>
          <input id="editText" type="text" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <div style="flex:1"><label for="editDate">Date</label><input id="editDate" type="date" /></div>
          <div style="width:140px"><label for="editTime">Time</label><input id="editTime" type="time" /></div>
          <div style="width:140px"><label for="editEndTime">End</label><input id="editEndTime" type="time" /></div>
        </div>
        <div id="editFieldsExtra" style="margin-top:8px">
          <div style="margin-top:8px">
            <label for="editLocation">Location</label>
            <div class="places-suggestions" style="margin-top:8px">
              <input id="editLocation" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" />
              <div id="editLocationList" class="suggestions-list" style="display:none"></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <div style="flex:1"><label for="editEmoji">Emoji</label><input id="editEmoji" type="text" placeholder="üéâ" /></div>
            <div style="width:140px"><label for="editCategory">Category</label><select id="editCategory"><option value="work">work</option><option value="personal">personal</option><option value="errands">errands</option></select></div>
            <div style="width:120px"><label for="editPriority">Priority</label><select id="editPriority"><option value="1">!</option><option value="2">!!</option><option value="3">!!!</option></select></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <div style="flex:1"><label for="editPreBuffer">Pre-buffer</label>
              <select id="editPreBuffer"><option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option><option value="20">20 min</option><option value="25">25 min</option><option value="30">30 min</option></select>
            </div>
            <div style="width:140px"><label for="editPostBuffer">Post-buffer</label>
              <select id="editPostBuffer"><option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option><option value="20">20 min</option><option value="25">25 min</option><option value="30">30 min</option></select>
            </div>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" id="cancelEdit" class="small-btn">Cancel</button>
          <button type="submit" id="saveEdit" style="background:#4a90e2;color:#fff;border:none;padding:8px 12px;border-radius:6px">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- bottom ribbon navigation -->
  <nav class="bottom-ribbon" role="navigation" aria-label="App pages">
    <a href="#events" class="r-item" data-view="events"><span>üìÖ</span><span class="r-label">Events</span></a>
    <a href="#reminders" class="r-item" data-view="reminders"><span>üîî</span><span class="r-label">Reminders</span></a>
    <a href="#calendar" class="r-item r-center" data-view="calendar"><span>üóìÔ∏è</span><span class="r-label">Calendar</span></a>
    <a href="#tasks" class="r-item" data-view="tasks"><span>‚úÖ</span><span class="r-label">Tasks</span></a>
    <a href="#settings" class="r-item" data-view="settings"><span>‚öôÔ∏è</span><span class="r-label">Settings</span></a>
  </nav>

  <script>
    // filepath: /Users/williamjoyce/Documents/GitHub/willlappschedule/assets/app.js (inlined)
    // Minimal utilities + storage
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const weekdayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    function pad2(n){ return n<10 ? '0'+n : ''+n; }
    function safeParseStorage(key, fallback){ try{ const raw=localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw);}catch(e){ console.warn('parse fail',e); localStorage.removeItem(key); return fallback; } }
    function getReminders(){ return safeParseStorage('reminders', {}); }
    function setReminders(v){ localStorage.setItem('reminders', JSON.stringify(v)); }
    function getTasks(){ return safeParseStorage('tasks', []); }
    function setTasks(v){ localStorage.setItem('tasks', JSON.stringify(v)); }
    function getEvents(){ return safeParseStorage('events', []); }
    function setEvents(v){ localStorage.setItem('events', JSON.stringify(v)); }

    // normalize date to YYYY-MM-DD or ''
    function normalizeDate(s){ if(!s) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d=new Date(s); if(isNaN(d)) return ''; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function migrateNormalizeTasks(){ try{ const tasks=getTasks(); let changed=false; for(let i=0;i<tasks.length;i++){ const nd=normalizeDate(tasks[i].date); if(tasks[i].date!==nd){ tasks[i].date=nd; changed=true; } } if(changed) setTasks(tasks);}catch(e){console.warn(e)} }

    // state
    let selectedMonth, selectedYear, selectedDay;

    // simple escape
    function escapeHTML(s){ return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* ---------- NEW: monthly color themes + holiday utilities ---------- */
    const themes = [
      /* Jan */ { weekday:'#f0f7ff', weekend:'#e6f1ff' },
      /* Feb */ { weekday:'#fff0f6', weekend:'#ffd9ec' },
      /* Mar */ { weekday:'#eefaf0', weekend:'#dff4e6' },
      /* Apr */ { weekday:'#fffaf0', weekend:'#fff3cc' },
      /* May */ { weekday:'#f0fcff', weekend:'#dff8ff' },
      /* Jun */ { weekday:'#fff7ec', weekend:'#fff0cc' },
      /* Jul */ { weekday:'#fff5f5', weekend:'#ffd9d9' },
      /* Aug */ { weekday:'#fff8e6', weekend:'#ffeecb' },
      /* Sep */ { weekday:'#f7fff7', weekend:'#e6f7ec' },
      /* Oct */ { weekday:'#fff6f0', weekend:'#ffeede' },
      /* Nov */ { weekday:'#f5f5fb', weekend:'#e8e8ff' },
      /* Dec */ { weekday:'#ffe6e6', weekend:'#e6ffe6' } // e.g. red (weekday) + green (weekend/holiday)
    ];

    const fixedHolidays = {
      '01-01':{name:"New Year's Day", emoji:'üéÜ'},
      '02-14':{name:"Valentine's Day", emoji:'‚ù§Ô∏è'},
      '03-17':{name:"St. Patrick's Day", emoji:'üçÄ'},
      '04-01':{name:"April Fool's Day", emoji:'ü§°'},
      '07-04':{name:"Independence Day", emoji:'üéá'},
      '10-31':{name:"Halloween", emoji:'üéÉ'},
      '12-25':{name:"Christmas Day", emoji:'üéÖ'}
    };

    function computeNthWeekday(year,monthIndex,weekday,n){
      const first = new Date(year,monthIndex,1);
      const firstWeekday = first.getDay();
      return 1 + ((7 + weekday - firstWeekday) % 7) + (n-1)*7;
    }
    function computeLastWeekday(year,monthIndex,weekday){
      const last = new Date(year,monthIndex+1,0);
      const lastWeekday = last.getDay();
      return last.getDate() - ((7 + lastWeekday - weekday) % 7);
    }
    function computeFederalHolidays(year){
      const map = {};
      map['01-'+pad2(computeNthWeekday(year,0,1,3))] = {name:"Martin Luther King Jr. Day", emoji:'‚úä'};
      map['02-'+pad2(computeNthWeekday(year,1,1,3))] = {name:"Presidents' Day", emoji:'üèõÔ∏è'};
      map['05-'+pad2(computeLastWeekday(year,4,1))] = {name:"Memorial Day", emoji:'üéóÔ∏è'};
      map['06-19'] = {name:"Juneteenth", emoji:'üè≥Ô∏è‚Äçüåà'};
      map['09-'+pad2(computeNthWeekday(year,8,1,1))] = {name:"Labor Day", emoji:'üõ†Ô∏è'};
      map['10-'+pad2(computeNthWeekday(year,9,1,2))] = {name:"Columbus Day", emoji:'üß≠'};
      map['11-'+pad2(computeNthWeekday(year,10,4,4))] = {name:"Thanksgiving", emoji:'ü¶É'};
      map['11-11'] = {name:"Veterans Day", emoji:'üéñÔ∏è'};
      return map;
    }

    function getHoliday(mmdd, year){
      // fixed-date first
      if (fixedHolidays[mmdd]) return fixedHolidays[mmdd];
      // compute federal holidays for year (cached minimally if you like)
      const fed = computeFederalHolidays(year);
      return fed[mmdd] || null;
    }
    /* ----------------------------------------------------------------- */

    // Calendar generation
    function generateCalendar(){
      const calendar = document.getElementById('calendar');
      const monthLabel = document.getElementById('monthLabel');
      if (!calendar || !monthLabel) { showAppError('Calendar container missing'); return; }
      calendar.innerHTML = '';
      monthLabel.textContent = monthNames[selectedMonth] + ' ' + selectedYear;

      for (let i=0;i<7;i++){
        const hdr = document.createElement('div');
        hdr.className = 'calendar-dayname';
        hdr.textContent = weekdayNames[i];
        calendar.appendChild(hdr);
      }

      const first = new Date(selectedYear, selectedMonth, 1);
      const start = first.getDay();
      const daysInMonth = new Date(selectedYear, selectedMonth+1, 0).getDate();
      const today = new Date();
      const isCurMonth = today.getFullYear()===selectedYear && today.getMonth()===selectedMonth;
      const reminders = getReminders();
      const events = getEvents();

      for (let i=0;i<start;i++) calendar.appendChild(document.createElement('div'));

      const theme = themes[selectedMonth] || { weekday:'#fff', weekend:'#f2f2f2' };

      for (let day=1; day<=daysInMonth; day++){
        const dt = new Date(selectedYear, selectedMonth, day);
        const dow = dt.getDay();
        const mmdd = pad2(selectedMonth+1)+'-'+pad2(day);
        const ymd = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.dataset.day = day;

        if (isCurMonth && day === today.getDate()) cell.classList.add('today');

        // treat holidays as weekends (use weekend color)
        const h = getHoliday(mmdd, selectedYear);
        cell.style.backgroundColor = (h || dow===0 || dow===6) ? theme.weekend : theme.weekday;

        const dayEvents = events.filter(e=>normalizeDate(e.date)===ymd);
        const dayTasks = getTasks().filter(t=>normalizeDate(t.date)===ymd);
        const dayReminders = reminders[ymd] || [];

        cell.innerHTML = `<div class="day-number">${day}</div><div class="emoji-row" aria-hidden="true"></div>`;

        // tooltip: holiday name or event summaries
        if (h) cell.title = h.name;
        else if (dayEvents.length) cell.title = dayEvents.map(e=>`${e.time||''} ${e.title}`).join('\n');

        // build unified indicators: events (each), holiday, reminder-summary, task-summary
        const indicators = [];
        dayEvents.forEach(ev => indicators.push({kind:'event', emoji: ev.emoji || 'üìå', title: (ev.time?`[${ev.time}] `:'') + (ev.title||''), id: ev.id}));
        if (h) indicators.push({kind:'holiday', emoji: h.emoji || 'üè≥Ô∏è', title: h.name});
        if (dayReminders.length) indicators.push({kind:'reminder', emoji: 'üîî', title: `${dayReminders.length} reminder${dayReminders.length>1?'s':''}`});
        if (dayTasks.length) indicators.push({kind:'task', emoji: '‚úÖ', title: `${dayTasks.length} task${dayTasks.length>1?'s':''}`});

        // render indicators into emoji-row using same sizing logic
        const emojiRow = cell.querySelector('.emoji-row');
        const count = Math.max(1, indicators.length);
        const size = Math.max(12, Math.floor(28 / Math.sqrt(count)));
        indicators.forEach(ind=>{
          const sp = document.createElement('span');
          sp.className = 'event-preview ' + (ind.kind || '');
          sp.textContent = ind.emoji || '';
          sp.title = ind.title || '';
          sp.style.fontSize = size + 'px';
          if (ind.kind === 'event' && ind.id) sp.dataset.eventId = ind.id;
          emojiRow.appendChild(sp);
        });

        cell.addEventListener('click', ()=> showReminders(day));
        if (selectedDay === day) cell.classList.add('selected');
        calendar.appendChild(cell);
      }
    }

    // Show reminders + events for a day
    function showReminders(day){
      selectedDay = day;
      [...document.querySelectorAll('.day')].forEach(c=>{ const d=parseInt(c.dataset.day,10); c.classList.toggle('selected', d===day); });
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const reminders = getReminders(); const items = reminders[key] || [];
      const events = getEvents().filter(e=> normalizeDate(e.date)===key );
      const untimed = events.filter(e=>!e.time).slice().sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      const timed = events.filter(e=>e.time).slice().sort((a,b)=> a.time === b.time ? (a.title||'').localeCompare(b.title||'') : (a.time||'').localeCompare(b.time||''));
      const eventsSorted = untimed.concat(timed);
      const rd = document.getElementById('selectedDateLong');
      if(rd){ rd.textContent = new Date(selectedYear, selectedMonth, day).toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); rd.style.display='block'; }
      const ribbons = document.getElementById('dayTopBars');
      const mmdd = pad2(selectedMonth+1)+'-'+pad2(day); // for holiday if desired
      let holidayHTML = '';
      let eventsHTML = '';
      if(eventsSorted.length){
        eventsHTML = `<div class="reminder-bar"><b>Events:</b><div class="events-list">${eventsSorted.map(ev=>{
          const timePart=ev.time?`[${escapeHTML(ev.time)}] `:''; const emojiPart=ev.emoji?ev.emoji+' ':''; const locationPart = ev.location?` @ <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.location)}" target="_blank">${escapeHTML(ev.location)}</a>`:''; const bufferPart = (ev.preBuffer||0)||(ev.postBuffer||0) ? ` <small style="color:#555">(${ev.preBuffer||0}m pre / ${ev.postBuffer||0}m post)</small>` : '';
          return `<div class="r-event">${timePart}${emojiPart}<b>${escapeHTML(ev.title)}</b>${locationPart}${bufferPart}<span class="r-actions"><button class="small-btn" onclick="editEvent(${ev.id})">Edit</button><button class="small-btn" onclick="deleteEvent(${ev.id})">Delete</button></span></div>`;
        }).join('')}</div></div>`;
      }
      ribbons.innerHTML = holidayHTML + eventsHTML;
      const reminderArea = document.getElementById('reminderBar');
      if(reminderArea){
        if(items.length){
          reminderArea.innerHTML = `<div class="reminder-bar"><b>Reminders for ${monthNames[selectedMonth]} ${day}, ${selectedYear}:</b><ul>${items.map((r,i)=>`<li>${r.time?`[${r.time}] `:''}${escapeHTML(r.text)} <span class="item-controls"><button class="small-btn" onclick="editReminder(${day},${i})">Edit</button><button class="small-btn" onclick="deleteReminder(${day},${i})">Delete</button></span></li>`).join('')}</ul></div>`;
        } else { reminderArea.innerHTML=''; }
      }
      updateDayProgress(day);
    }

    // Reminders CRUD
    function addReminder(e){
      if(e && e.preventDefault) e.preventDefault();
      let dateKey = null;
      if(selectedDay) dateKey = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(selectedDay)}`;
      else { const inp=document.getElementById('reminderDate'); if(inp && inp.value) dateKey = normalizeDate(inp.value); }
      if(!dateKey){ alert('Select a day on calendar or choose a date on Reminders page'); return; }
      const txt = (document.getElementById('reminderInput')||{value:''}).value.trim(); if(!txt) return;
      const time = (document.getElementById('reminderTime')||{value:''}).value || '';
      const r = getReminders(); if(!r[dateKey]) r[dateKey]=[]; r[dateKey].push({text:txt,time}); setReminders(r);
      (document.getElementById('reminderInput')||{value:''}).value=''; (document.getElementById('reminderTime')||{value:''}).value='';
      const parts = dateKey.split('-'); if(parts.length===3){ selectedYear=parseInt(parts[0],10); selectedMonth=parseInt(parts[1],10)-1; selectedDay=parseInt(parts[2],10); }
      generateCalendar(); showReminders(selectedDay);
    }
    function deleteReminder(day,index){
      if(!confirm('Delete this reminder?')) return;
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const r=getReminders(); if(!r[key]) return; r[key].splice(index,1); if(!r[key].length) delete r[key]; setReminders(r); showReminders(day); generateCalendar();
    }
    function editReminder(day,index){
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const r=getReminders(); const arr = r[key]||[]; const item = arr[index]; if(!item) return;
      document.getElementById('editKind').value='reminder'; document.getElementById('editReminderKey').value=key; document.getElementById('editReminderIndex').value=index;
      document.getElementById('editText').value=item.text||''; document.getElementById('editDate').value=key; document.getElementById('editTime').value=item.time||''; showModalFieldsFor('reminder'); openEditModal('Edit Reminder');
    }

    // Tasks CRUD
    function loadTasks(){
      const tasks = getTasks(); const list = document.getElementById('taskList'); if(!list) return; list.innerHTML='';
      const pmap={'1':'!','2':'!!','3':'!!!'};
      tasks.forEach((t,i)=>{
        const li=document.createElement('li');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!t.done;
        cb.addEventListener('change',()=>{ const all=getTasks(); all[i].done = cb.checked; setTasks(all); updateProgress(all); updateDashboard(all); updateDayProgress(selectedDay); loadTasks(); });
        const span=document.createElement('span'); span.innerHTML = ` ${escapeHTML(t.text)} ${t.date?`[${t.date}]`:''} ${t.time?`[${t.time}]`:''} Priority:${pmap[t.priority]||t.priority}`; span.className = `category-${t.category||''}`;
        const editBtn=document.createElement('button'); editBtn.className='small-btn'; editBtn.textContent='Edit'; editBtn.addEventListener('click',()=>editTask(i));
        const delBtn=document.createElement('button'); delBtn.className='small-btn'; delBtn.textContent='Delete'; delBtn.addEventListener('click',()=>deleteTask(i));
        li.appendChild(cb); li.appendChild(span); li.appendChild(editBtn); li.appendChild(delBtn); list.appendChild(li);
      });
      updateProgress(tasks); updateDashboard(tasks); updateDayProgress(selectedDay);
    }
    function addTask(e){
      if(e && e.preventDefault) e.preventDefault();
      const text=(document.getElementById('newTask')||{value:''}).value.trim(); if(!text) return;
      const category=document.getElementById('taskCategory')?document.getElementById('taskCategory').value:'work';
      const date=normalizeDate(document.getElementById('taskDate')?document.getElementById('taskDate').value:'');
      const time=document.getElementById('taskTime')?document.getElementById('taskTime').value:'';
      const priority=document.getElementById('taskPriority')?document.getElementById('taskPriority').value:'2';
      const tasks=getTasks(); tasks.push({text,category,done:false,date,time,priority}); setTasks(tasks);
      document.getElementById('newTask').value=''; if(document.getElementById('taskDate')) document.getElementById('taskDate').value=''; if(document.getElementById('taskTime')) document.getElementById('taskTime').value='';
      loadTasks();
    }
    function deleteTask(i){ if(!confirm('Delete this task?')) return; const tasks=getTasks(); tasks.splice(i,1); setTasks(tasks); loadTasks(); }
    function editTask(i){
      const tasks=getTasks(); const t=tasks[i]; if(!t) return;
      document.getElementById('editKind').value='task'; document.getElementById('editTaskIndex').value=i;
      document.getElementById('editText').value=t.text||''; document.getElementById('editDate').value=t.date||''; document.getElementById('editTime').value=t.time||'';
      document.getElementById('editCategory').value=t.category||'work'; document.getElementById('editPriority').value=t.priority||'2';
      showModalFieldsFor('task'); openEditModal('Edit Task');
    }

    // Events CRUD
    function renderEvents(){
      const evs=getEvents(); const list=document.getElementById('eventList'); if(!list) return; list.innerHTML='';
      evs.forEach(e=>{
        const li=document.createElement('li');
        const locHtml=e.location?` @ <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}" target="_blank">${escapeHTML(e.location)}</a>`:'';
        const bufferHtml=((e.preBuffer||0)||(e.postBuffer||0))?` <small style="color:#555">(${e.preBuffer||0}m pre / ${e.postBuffer||0}m post)</small>`:'';
        li.innerHTML = `${e.emoji?e.emoji+' ':''}<b>${escapeHTML(e.title)}</b> ‚Äî ${e.date} ${e.time?`[${e.time}]`:''}${locHtml}${bufferHtml} <span class="item-controls"><button class="small-btn" onclick="editEvent(${e.id})">Edit</button><button class="small-btn" onclick="deleteEvent(${e.id})">Delete</button></span>`;
        list.appendChild(li);
      });
    }
    function addEvent(e){ if(e && e.preventDefault) e.preventDefault();
      const title=(document.getElementById('eventTitle')||{value:''}).value.trim(); const date=normalizeDate(document.getElementById('eventDate')?document.getElementById('eventDate').value:'');
      if(!title||!date){ alert('Event needs a title and date'); return; }
      const time=document.getElementById('eventTime')?document.getElementById('eventTime').value:''; const endTime=document.getElementById('eventEndTime')?document.getElementById('eventEndTime').value:''; const location=document.getElementById('eventLocation')?document.getElementById('eventLocation').value.trim():''; const emoji=document.getElementById('eventEmoji')?document.getElementById('eventEmoji').value.trim():'';
      const pre=parseInt(document.getElementById('eventPreBuffer')?document.getElementById('eventPreBuffer').value:0,10)||0; const post=parseInt(document.getElementById('eventPostBuffer')?document.getElementById('eventPostBuffer').value:0,10)||0;
      const evs=getEvents(); const id = evs.length?Math.max(...evs.map(x=>x.id))+1:1; evs.push({id,title,date,time,endTime,location,emoji,preBuffer:pre,postBuffer:post}); setEvents(evs);
      if(document.getElementById('eventTitle'))document.getElementById('eventTitle').value=''; if(document.getElementById('eventDate'))document.getElementById('eventDate').value=''; if(document.getElementById('eventTime'))document.getElementById('eventTime').value=''; if(document.getElementById('eventEndTime'))document.getElementById('eventEndTime').value=''; renderEvents(); generateCalendar();
    }
    function deleteEvent(id){ if(!confirm('Delete this event?')) return; let evs=getEvents(); evs=evs.filter(e=>e.id!==id); setEvents(evs); renderEvents(); generateCalendar(); if(selectedDay) showReminders(selectedDay); }
    function editEvent(id){ const evs=getEvents(); const idx=evs.findIndex(e=>e.id===id); if(idx===-1) return; const e=evs[idx];
      document.getElementById('editKind').value='event'; document.getElementById('editEventId').value=id; document.getElementById('editText').value=e.title||''; document.getElementById('editDate').value=e.date||''; document.getElementById('editTime').value=e.time||''; document.getElementById('editEndTime').value=e.endTime||''; document.getElementById('editLocation').value=e.location||''; document.getElementById('editEmoji').value=e.emoji||''; document.getElementById('editPreBuffer').value=(e.preBuffer||5); document.getElementById('editPostBuffer').value=(e.postBuffer||5); showModalFieldsFor('event'); openEditModal('Edit Event'); }

    // Modal helpers
    function openEditModal(title){ const m=document.getElementById('editModal'); const h=document.getElementById('editModalHeading'); if(h) h.textContent=title; if(m){ m.classList.remove('hidden'); m.style.display='flex'; } }
    function closeEditModal(){ const m=document.getElementById('editModal'); if(m){ m.classList.add('hidden'); m.style.display='none'; } }
    function showModalFieldsFor(kind){
      const loc=document.getElementById('editLocation'), emoji=document.getElementById('editEmoji'), category=document.getElementById('editCategory'), priority=document.getElementById('editPriority');
      if(!loc||!emoji||!category||!priority) return;
      if(kind==='event'){ loc.parentElement.style.display='block'; emoji.parentElement.style.display='block'; category.parentElement.style.display='none'; priority.parentElement.style.display='none'; }
      else if(kind==='task'){ loc.parentElement.style.display='none'; emoji.parentElement.style.display='none'; category.parentElement.style.display='block'; priority.parentElement.style.display='block'; }
      else { loc.parentElement.style.display='none'; emoji.parentElement.style.display='none'; category.parentElement.style.display='none'; priority.parentElement.style.display='none'; }
    }
    function saveEditHandler(e){ 
      e.preventDefault();
      const kind = document.getElementById('editKind').value;
      const text = document.getElementById('editText').value.trim();
      const date = normalizeDate(document.getElementById('editDate').value);
      const time = document.getElementById('editTime').value || '';

      if (kind==='event'){
        const id = parseInt(document.getElementById('editEventId').value,10);
        const evs = getEvents(); 
        const idx = evs.findIndex(x=>x.id===id); 
        if (idx===-1){ closeEditModal(); return; }

        // <-- Fixed: use proper property assignments (was a malformed expression causing a syntax/runtime failure) -->
        evs[idx].title = text;
        evs[idx].date = date;
        evs[idx].time = time;
        evs[idx].endTime = document.getElementById('editEndTime').value || '';
        evs[idx].location = (document.getElementById('editLocation') || {}).value ? document.getElementById('editLocation').value.trim() : '';
        evs[idx].emoji = (document.getElementById('editEmoji') || {}).value ? document.getElementById('editEmoji').value.trim() : '';
        evs[idx].preBuffer = parseInt((document.getElementById('editPreBuffer') || {value:0}).value,10) || 0;
        evs[idx].postBuffer = parseInt((document.getElementById('editPostBuffer') || {value:0}).value,10) || 0;

        setEvents(evs); renderEvents(); generateCalendar(); if (selectedDay) showReminders(selectedDay);
      }

      /* ...existing code for other kinds (task, reminder) ... */

      closeEditModal();
    }

    // dashboard & progress
    function updateProgress(tasks){ const total=tasks.length; const done=tasks.filter(t=>t.done).length; const percent = total?Math.round((done/total)*100):0; const ring=document.getElementById('progressRing'); if(ring){ ring.style.borderTopColor = percent===100 ? 'limegreen' : '#4a90e2'; ring.title = percent + '% complete'; ring.style.transform = `rotate(${percent*3.6}deg)`; } }
    function updateDashboard(tasks){ const total=tasks.length; const done=tasks.filter(t=>t.done).length; const categories=tasks.reduce((acc,t)=>{acc[t.category]=(acc[t.category]||0)+1; return acc;},{});
      const summary=document.getElementById('summaryStats'); if(summary) summary.innerHTML=`Total tasks: ${total}<br>Completed: ${done}<br>Work: ${categories.work||0}, Personal: ${categories.personal||0}, Errands: ${categories.errands||0}`; }
    function updateDayProgress(day){ const ring=document.getElementById('dayProgressRing'); if(!ring) return; if(!day){ ring.style.borderTopColor='#ccc'; ring.title='No day selected'; ring.style.transform='rotate(0deg)'; return; } const key=`${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`; const tasks=getTasks().filter(t => t.date && normalizeDate(t.date)===key ); const total=tasks.length; const done=tasks.filter(t=>t.done).length; const percent = total?Math.round((done/total)*100):0; ring.style.borderTopColor = percent===100 ? 'limegreen' : '#4a90e2'; ring.title = percent + '% complete (' + total + ' task' + (total!==1?'s':'') + ') on ' + key; ring.style.transform=`rotate(${percent*3.6}deg)`; }

    // Places (optional)
    function initPlaces(){
      if(!window.google || !google.maps || !google.maps.places){ console.warn('Google Places not loaded'); return; }
      try{
        const acService = new google.maps.places.AutocompleteService();
        const placesSvc = new google.maps.places.PlacesService(document.createElement('div'));
        function attachAutocompleteUI(input, listEl){
          let currentRequestId=0; input.dataset.place='';
          function hideList(){ listEl.style.display='none'; listEl.innerHTML=''; }
          input.addEventListener('input', function(){ const q=input.value.trim(); if(!q) { hideList(); return; } const reqId=++currentRequestId; acService.getPlacePredictions({ input:q, types:['geocode'] }, (preds)=>{ if(reqId!==currentRequestId) return; if(!preds||!preds.length){ hideList(); return; } listEl.innerHTML=''; preds.forEach(p=>{ const btn=document.createElement('button'); btn.type='button'; btn.textContent=p.description; btn.addEventListener('click', ()=>{ input.value=p.description; hideList(); input.dataset.place=JSON.stringify({description:p.description,placeId:p.place_id}); placesSvc.getDetails({ placeId:p.place_id, fields:['formatted_address','geometry','place_id'] }, (detail,st)=>{ if(st===google.maps.places.PlacesServiceStatus.OK && detail){ input.value = detail.formatted_address || input.value; input.dataset.place = JSON.stringify({ address: detail.formatted_address || p.description, lat: detail.geometry && detail.geometry.location ? detail.geometry.location.lat() : null, lng: detail.geometry && detail.geometry.location ? detail.geometry.location.lng() : null, placeId: detail.place_id || p.place_id }); } }); input.dispatchEvent(new Event('change')); }); listEl.appendChild(btn); }); listEl.style.display='block'; }); });
          input.addEventListener('blur', ()=> setTimeout(hideList,200));
          input.addEventListener('focus', ()=> { if(input.value && listEl.children.length) listEl.style.display='block'; });
          input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') e.stopPropagation(); });
        }
        const evtInput=document.getElementById('eventLocation'), evtList=document.getElementById('eventLocationList'); if(evtInput && evtList) attachAutocompleteUI(evtInput, evtList);
        const editInput=document.getElementById('editLocation'), editList=document.getElementById('editLocationList'); if(editInput && editList) attachAutocompleteUI(editInput, editList);
      }catch(e){ console.warn('initPlaces err',e); }
    }

    // SPA view switching
    function showView(view, updateHash = true){
      // normalize view
      view = view || 'calendar';
      document.querySelectorAll('[id^="page-"]').forEach(s=>s.classList.add('hidden'));
      const el = document.getElementById('page-'+view);
      if (el) el.classList.remove('hidden');
      document.querySelectorAll('.bottom-ribbon .r-item').forEach(a=>a.classList.toggle('active', a.dataset.view===view));
      // update calendar/events/tasks UI as before
      if(view==='calendar'){ generateCalendar(); if(selectedDay) showReminders(selectedDay); }
      if(view==='tasks') loadTasks();
      if(view==='events') renderEvents();
      if(view==='reminders'){ /* ...existing reminders refresh if needed... */ }

      // keep the hash in sync without causing recursion
      if (updateHash){
        const newHash = '#'+view;
        if (location.hash !== newHash) location.hash = newHash;
      }
    }

    // on load: attach listeners only when corresponding elements exist
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        migrateNormalizeTasks();
        const now=new Date();
        selectedMonth = now.getMonth(); selectedYear = now.getFullYear(); selectedDay = now.getDate();

        // ribbon clicks (anchor hrefs are hashes, no preventDefault needed for navigation from other pages)
        document.querySelectorAll('.bottom-ribbon .r-item').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            // On the SPA (index) we want client-side navigation.
            if (location.pathname.endsWith('index.html') || location.pathname.endsWith('/') ){
              ev.preventDefault();
              const v = a.dataset.view || 'calendar';
              showView(v);
            }
            // Otherwise, anchors with href="#..." will navigate to index.html#view when clicked from other pages.
          });
        });

        // calendar nav (guarded)
        const prev = document.getElementById('prevBtn');
        if (prev) prev.addEventListener('click', ()=>{ selectedMonth--; if(selectedMonth<0){ selectedMonth=11; selectedYear--; } generateCalendar(); selectedDay = Math.min(selectedDay||1, new Date(selectedYear,selectedMonth+1,0).getDate()); showReminders(selectedDay); });
        const next = document.getElementById('nextBtn');
        if (next) next.addEventListener('click', ()=>{ selectedMonth++; if(selectedMonth>11){ selectedMonth=0; selectedYear++; } generateCalendar(); selectedDay = Math.min(selectedDay||1, new Date(selectedYear,selectedMonth+1,0).getDate()); showReminders(selectedDay); });

        // forms (guarded)
        const evtForm = document.getElementById('eventForm'); if (evtForm) evtForm.addEventListener('submit', addEvent);
        const remForm = document.getElementById('reminderForm'); if (remForm) remForm.addEventListener('submit', addReminder);
        const tForm = document.getElementById('taskForm'); if (tForm) tForm.addEventListener('submit', addTask);

        // edit modal handlers (guarded)
        const cancelBtn = document.getElementById('cancelEdit'); if (cancelBtn) cancelBtn.addEventListener('click', closeEditModal);
        const editForm = document.getElementById('editForm'); if (editForm) editForm.addEventListener('submit', saveEditHandler);

        // initial render: use hash if present
        const initial = (location.hash && location.hash.length>1) ? location.hash.slice(1) : 'calendar';
        showView(initial, false);

        // attempt to init Places if API key set
        if(window.google && google.maps && google.maps.places) initPlaces();
        else {
          const MAPS_API_KEY = (window.MAPS_API_KEY || localStorage.getItem('MAPS_API_KEY') || 'YOUR_API_KEY').trim();
          if(MAPS_API_KEY && MAPS_API_KEY !== 'YOUR_API_KEY'){
            const s = document.createElement('script'); s.async=true; s.defer=true;
            s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(MAPS_API_KEY)}&libraries=places`;
            s.onload = initPlaces; s.onerror = ()=>console.warn('maps load failed'); document.head.appendChild(s);
          } else console.info('Maps API key not set; skipping Places init');
        }
      }catch(err){ console.error('Init error',err); alert('Initialization error: '+(err && err.message || err)); }
    });

    // respond to back/forward and external hash navigation
    window.addEventListener('hashchange', ()=>{
      const v = (location.hash && location.hash.length>1) ? location.hash.slice(1) : 'calendar';
      showView(v, false);
    });

    // expose functions used by inline handlers
    window.editEvent = editEvent;
    window.deleteEvent = deleteEvent;
    window.editReminder = editReminder;
    window.deleteReminder = deleteReminder;
  </script>
</body>
</html>