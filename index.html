<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeScape Planner</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; text-align:center; }
    header { background:#4a90e2; color:#fff; padding:1rem; font-size:1.25rem; }
    .calendar-controls{display:flex;gap:10px;justify-content:center;align-items:center;margin:18px 0;}
    .calendar-controls button{background:#4a90e2;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:10px;width:calc(100vw - 32px);max-width:100%;margin:0 auto 12px;background:#fff;border-radius:10px;box-shadow:0 1px 8px rgba(0,0,0,0.07);box-sizing:border-box;}
    .calendar-dayname{font-weight:700;color:#4a90e2;padding-bottom:4px}
    .day{background:#fff;border-radius:8px;padding:8px;min-height:64px;position:relative;cursor:pointer;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .day.selected{border:2px solid #4a90e2;box-shadow:0 2px 8px rgba(74,144,226,0.15)}
    .day.today{outline:2px solid #4a90e2;}
    .day .day-number{font-weight:700;display:flex;gap:6px;align-items:center;justify-content:flex-start}
    .reminder-dot{width:8px;height:8px;border-radius:50%;background:#e67e22;display:inline-block}
    .reminder-bar{background:#fbeee6;border-left:4px solid #e67e22;color:#9a6b16;margin:8px 0;padding:8px;border-radius:6px;font-size:0.95rem;text-align:left}
    .item-controls{margin-left:8px}
    .small-btn{padding:4px 6px;background:#888;color:#fff;border:none;border-radius:4px;margin-left:6px;cursor:pointer}
    .tasks,.events,.reminders,.dashboard{max-width:540px;margin:18px auto;text-align:left;padding:0 12px;box-sizing:border-box}
    input[type="text"],input[type="date"],input[type="time"],select{padding:8px;border-radius:4px;border:1px solid #ccc;width:100%;box-sizing:border-box;margin-top:6px}
    .mobile-row{display:flex;gap:8px;align-items:center}
    .mobile-label{display:none;font-weight:600;margin-right:8px}
    @media (max-width:600px){ .mobile-label{display:inline-block} .calendar,.tasks,.events,.reminders{width:calc(100vw - 32px);}}
    #editModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;z-index:9999}
    #editModal .panel{background:#fff;padding:16px;border-radius:8px;max-width:520px;width:94%;box-shadow:0 6px 30px rgba(0,0,0,0.2);text-align:left}
    #editModal label{font-weight:600}
  </style>
</head>
<body>
  <header>üìÖ TimeScape Planner</header>

  <div class="calendar-controls">
    <button id="prevBtn">&lt;</button>
    <span id="monthLabel" aria-live="polite"></span>
    <button id="nextBtn">&gt;</button>
  </div>

  <section id="calendar" class="calendar" role="grid" aria-label="Calendar"></section>

  <section class="reminders">
    <div id="reminderHeader">
      <h2 id="reminderDate" style="display:none;margin-bottom:8px"></h2>
      <h2>‚è∞ Reminders</h2>
    </div>

    <!-- ribbons for holiday + events shown under long date -->
    <div id="dayTopBars"></div>

    <div id="reminderBar" aria-live="polite"></div>

    <div style="margin-top:12px" class="mobile-row">
      <label class="mobile-label" for="reminderInput">Reminder</label>
      <input type="text" id="reminderInput" placeholder="Add reminder to selected day..." />
    </div>
    <div style="margin-top:8px" class="mobile-row">
      <label class="mobile-label" for="reminderTime">Time</label>
      <input type="time" id="reminderTime" style="width:36%" />
      <button id="addReminderBtn" style="width:auto;margin-left:8px">Add Reminder</button>
    </div>
  </section>

  <!-- edit modal -->
  <div id="editModal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3 id="editModalHeading">Edit</h3>
      <form id="editForm">
        <input type="hidden" id="editKind" />
        <input type="hidden" id="editEventId" />
        <input type="hidden" id="editTaskIndex" />
        <input type="hidden" id="editReminderKey" />
        <input type="hidden" id="editReminderIndex" />

        <div style="margin-top:8px;">
          <label for="editText">Text / Title</label>
          <input id="editText" type="text" />
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <div style="flex:1">
            <label for="editDate">Date</label>
            <input id="editDate" type="date" />
          </div>
          <div style="width:140px">
            <label for="editTime">Time</label>
            <input id="editTime" type="time" />
          </div>
        </div>

        <div id="editFieldsExtra" style="margin-top:8px">
          <div style="margin-top:8px">
            <label for="editLocation">Location</label>
            <input id="editLocation" type="text" />
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <div style="flex:1">
              <label for="editEmoji">Emoji</label>
              <input id="editEmoji" type="text" placeholder="üéâ" />
            </div>

            <div style="width:140px">
              <label for="editCategory">Category</label>
              <select id="editCategory">
                <option value="work">work</option>
                <option value="personal">personal</option>
                <option value="errands">errands</option>
              </select>
            </div>

            <div style="width:120px">
              <label for="editPriority">Priority</label>
              <select id="editPriority">
                <option value="1">!</option>
                <option value="2">!!</option>
                <option value="3">!!!</option>
              </select>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" id="cancelEdit" class="small-btn">Cancel</button>
          <button type="submit" id="saveEdit" style="background:#4a90e2;color:#fff;border:none;padding:8px 12px;border-radius:6px">Save</button>
        </div>
      </form>
    </div>
  </div>

  <section class="events">
    <h2>üìÖ Events</h2>
    <input id="eventTitle" type="text" placeholder="Event title" />
    <div class="mobile-row" style="margin-top:8px">
      <input id="eventDate" type="date" />
      <input id="eventTime" type="time" />
    </div>
    <input id="eventLocation" type="text" placeholder="Location" style="margin-top:8px" />
    <input id="eventEmoji" type="text" placeholder="Emoji (e.g. üéâ)" style="margin-top:8px;width:36%" />
    <div style="margin-top:8px">
      <button id="addEventBtn">Add Event</button>
    </div>
    <ul id="eventList"></ul>
  </section>

  <section class="tasks">
    <h2>‚úÖ Tasks</h2>
    <input id="newTask" type="text" placeholder="Add a task..." />
    <div style="display:flex;gap:8px;margin-top:8px">
      <select id="taskCategory" style="width:40%">
        <option value="work">Work</option>
        <option value="personal">Personal</option>
        <option value="errands">Errands</option>
      </select>
      <input id="taskDate" type="date" style="flex:1" />
      <input id="taskTime" type="time" style="width:120px" />
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <select id="taskPriority" style="width:120px">
        <option value="1">!</option>
        <option value="2">!!</option>
        <option value="3">!!!</option>
      </select>
      <button id="addTaskBtn">Add</button>
    </div>
    <ul id="taskList"></ul>
  </section>

  <section class="dashboard">
    <h2>üìä Dashboard</h2>
    <p id="summaryStats"></p>
    <div class="progress" id="progressRing" title="0% complete"></div>
  </section>

  <script>
    function showAppError(msg) {
      try {
        let el = document.getElementById('appError');
        if (!el) {
          el = document.createElement('div');
          el.id = 'appError';
          el.style.background = '#ffecec';
          el.style.color = '#900';
          el.style.padding = '8px 12px';
          el.style.margin = '8px 16px';
          el.style.border = '1px solid #f5c6cb';
          el.style.borderRadius = '6px';
          const header = document.querySelector('header') || document.body;
          header.insertAdjacentElement('afterend', el);
        }
        el.textContent = msg;
        console.warn('App message:', msg);
      } catch (e) { console.warn('showAppError failed', e); }
    }

    const calendar = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');
    const reminderBar = document.getElementById('reminderBar');
    const reminderInput = document.getElementById('reminderInput');
    const reminderTime = document.getElementById('reminderTime');

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const weekdayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const themes = [
      {weekday:'#cce5ff',weekend:'#e0ccff'},{weekday:'#ffd6e0',weekend:'#e6ccff'},{weekday:'#d6f5d6',weekend:'#cce0ff'},
      {weekday:'#fff0b3',weekend:'#ffd9b3'},{weekday:'#e6ffe6',weekend:'#ccf2ff'},{weekday:'#ffe6cc',weekend:'#ffcccc'},
      {weekday:'#fff5cc',weekend:'#ffd6cc'},{weekday:'#e6f7ff',weekend:'#d9e6f2'},{weekday:'#ffe6b3',weekend:'#ffccb3'},
      {weekday:'#ffd9b3',weekend:'#e6ccb3'},{weekday:'#e6f0ff',weekend:'#d6e6f5'},{weekday:'#ffcccc',weekend:'#ccffcc'}
    ];

    const holidays = {
      '01-01':{name:"New Year's Day",emoji:'üéÜ'},
      '02-14':{name:"Valentine's Day",emoji:'‚ù§Ô∏è'},
      '03-17':{name:"St. Patrick's Day",emoji:'üçÄ'},
      '04-01':{name:"April Fool's Day",emoji:'ü§°'},
      '07-04':{name:"Independence Day",emoji:'üéá'},
      '10-31':{name:"Halloween",emoji:'üéÉ'},
      '12-25':{name:"Christmas Day",emoji:'üéÖ'}
    };

    function pad2(n){ return n<10 ? '0'+n : ''+n; }

    function safeParseStorage(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){
        console.warn('LocalStorage parse failed for', key, e);
        try{ localStorage.removeItem(key); }catch(_) {}
        return fallback;
      }
    }

    function getReminders(){ return safeParseStorage('reminders', {}); }
    function setReminders(v){ localStorage.setItem('reminders', JSON.stringify(v)); }
    function getTasks(){ return safeParseStorage('tasks', []); }
    function setTasks(v){ localStorage.setItem('tasks', JSON.stringify(v)); }
    function getEvents(){ return safeParseStorage('events', []); }
    function setEvents(v){ localStorage.setItem('events', JSON.stringify(v)); }

    function computeNthWeekday(year,monthIndex,weekday,n){
      const first = new Date(year,monthIndex,1);
      const firstWeekday = first.getDay();
      return 1 + ((7 + weekday - firstWeekday) % 7) + (n-1)*7;
    }
    function computeLastWeekday(year,monthIndex,weekday){
      const last = new Date(year,monthIndex+1,0);
      const lastWeekday = last.getDay();
      return last.getDate() - ((7 + lastWeekday - weekday) % 7);
    }
    function computeFederalHolidays(year){
      const map = {};
      map['01-'+pad2(computeNthWeekday(year,0,1,3))] = {name:"Martin Luther King Jr. Day",emoji:'‚úä'};
      map['02-'+pad2(computeNthWeekday(year,1,1,3))] = {name:"Presidents' Day",emoji:'üèõÔ∏è'};
      map['05-'+pad2(computeLastWeekday(year,4,1))] = {name:"Memorial Day",emoji:'üéóÔ∏è'};
      map['06-19'] = {name:"Juneteenth National Independence Day",emoji:'üè≥Ô∏è‚Äçüåà'};
      map['09-'+pad2(computeNthWeekday(year,8,1,1))] = {name:"Labor Day",emoji:'üõ†Ô∏è'};
      map['10-'+pad2(computeNthWeekday(year,9,1,2))] = {name:"Columbus Day",emoji:'üß≠'};
      map['11-'+pad2(computeNthWeekday(year,10,4,4))] = {name:"Thanksgiving",emoji:'ü¶É'};
      map['11-11'] = {name:"Veterans Day",emoji:'üéñÔ∏è'};
      return map;
    }
    function getHoliday(mmdd, year){
      if (holidays[mmdd]) return holidays[mmdd];
      const c = computeFederalHolidays(year);
      return c[mmdd] || null;
    }

    let selectedMonth, selectedYear, selectedDay;

    function generateCalendar(){
      if (!calendar) { showAppError('Calendar container missing'); return; }
      calendar.innerHTML = '';
      monthLabel.textContent = monthNames[selectedMonth] + ' ' + selectedYear;

      for (let i=0;i<7;i++){
        const hdr = document.createElement('div');
        hdr.className = 'calendar-dayname';
        hdr.textContent = weekdayNames[i];
        calendar.appendChild(hdr);
      }

      const first = new Date(selectedYear, selectedMonth, 1);
      const start = first.getDay();
      const daysInMonth = new Date(selectedYear, selectedMonth+1, 0).getDate();
      const today = new Date();
      const isCurMonth = today.getFullYear()===selectedYear && today.getMonth()===selectedMonth;
      const reminders = getReminders();
      const events = getEvents();

      for (let i=0;i<start;i++) calendar.appendChild(document.createElement('div'));

      const theme = themes[selectedMonth] || themes[0];

      for (let day=1; day<=daysInMonth; day++){
        const dt = new Date(selectedYear, selectedMonth, day);
        const dow = dt.getDay();
        const mmdd = pad2(selectedMonth+1)+'-'+pad2(day);
        const ymd = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.dataset.day = day;

        if (isCurMonth && day === today.getDate()) cell.classList.add('today');

        cell.style.backgroundColor = (dow===0||dow===6) ? theme.weekend : theme.weekday;

        const h = getHoliday(mmdd, selectedYear);
        const dayEvents = events.filter(e=>e.date===ymd);
        const eventEmoji = dayEvents.length ? (dayEvents[0].emoji || 'üìå') : null;

        const numberHtml = h ? `${day} <span>${h.emoji}</span>` : (eventEmoji ? `${day} <span>${eventEmoji}</span>` : `${day}`);
        cell.innerHTML = `<div class="day-number">${numberHtml}</div>`;

        if (h) { cell.classList.add('holiday'); cell.title = h.name; }
        else if (eventEmoji) cell.title = dayEvents.map(e=>`${e.time||''} ${e.title}`).join('\n');

        if (reminders[ymd] && reminders[ymd].length){
          const dot = document.createElement('span'); dot.className = 'reminder-dot';
          const num = cell.querySelector('.day-number') || cell;
          num.appendChild(dot);
        }

        cell.addEventListener('click', ()=> showReminders(day));
        if (selectedDay === day) cell.classList.add('selected');

        calendar.appendChild(cell);
      }
    }

    function showReminders(day){
      selectedDay = day;
      [...calendar.querySelectorAll('.day')].forEach(c=>{
        const d = parseInt(c.dataset.day,10);
        c.classList.toggle('selected', d===day);
      });

      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const reminders = getReminders();
      const items = reminders[key] || [];
      const events = getEvents().filter(e=>e.date===key);

      const rd = document.getElementById('reminderDate');
      if (rd) {
        rd.textContent = new Date(selectedYear, selectedMonth, day).toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        rd.style.display='block';
      }

      const mmdd = pad2(selectedMonth+1)+'-'+pad2(day);
      const h = getHoliday(mmdd, selectedYear);

      const holidayHTML = h ? `<div class="reminder-bar" style="background:#ffe5e3;border-left:4px solid #c0392b;color:#c0392b"><b>${h.emoji} ${h.name}</b></div>` : '';
      const eventsHTML = events.length ? `<div class="reminder-bar" style="background:#eef6ff;border-left:4px solid #4a90e2;color:#234"><b>Events:</b><ul>${events.map(ev=>`<li>${ev.time?`[${ev.time}] `:''}${ev.emoji?ev.emoji+' ':''}<b>${escapeHTML(ev.title)}</b> ${escapeHTML(ev.location||'')} <span class="item-controls"><button class="small-btn" onclick="editEvent(${ev.id})">Edit</button><button class="small-btn" onclick="deleteEvent(${ev.id})">Delete</button></span></li>`).join('')}</ul></div>` : '';

      const ribbons = document.getElementById('dayTopBars');
      if (ribbons) ribbons.innerHTML = holidayHTML + eventsHTML;

      const reminderArea = document.getElementById('reminderBar');
      if (reminderArea) {
        if (items.length){
          reminderArea.innerHTML = `<div class="reminder-bar"><b>Reminders for ${monthNames[selectedMonth]} ${day}, ${selectedYear}:</b><ul>${items.map((r,i)=>`<li>${r.time?`[${r.time}] `:''}${escapeHTML(r.text)} <span class="item-controls"><button class="small-btn" onclick="editReminder(${day},${i})">Edit</button><button class="small-btn" onclick="deleteReminder(${day},${i})">Delete</button></span></li>`).join('')}</ul></div>`;
        } else {
          reminderArea.innerHTML = '';
        }
      }
    }

    function addReminder(){
      if (!selectedDay){ alert('Select a day first'); return; }
      const txt = reminderInput.value.trim(); if (!txt) return;
      const time = reminderTime.value || '';
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(selectedDay)}`;
      const r = getReminders();
      if (!r[key]) r[key] = [];
      r[key].push({text:txt,time});
      setReminders(r);
      reminderInput.value=''; reminderTime.value='';
      showReminders(selectedDay); generateCalendar();
    }

    function deleteReminder(day,index){
      if (!confirm('Delete this reminder?')) return;
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const r = getReminders();
      if (!r[key]) return;
      r[key].splice(index,1);
      if (!r[key].length) delete r[key];
      setReminders(r);
      showReminders(day); generateCalendar();
    }

    function editReminder(day,index){
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const r = getReminders();
      const arr = r[key]||[];
      const item = arr[index];
      if (!item) return;
      document.getElementById('editKind').value='reminder';
      document.getElementById('editReminderKey').value=key;
      document.getElementById('editReminderIndex').value=index;
      document.getElementById('editText').value = item.text||'';
      document.getElementById('editDate').value = key;
      document.getElementById('editTime').value = item.time || '';
      showModalFieldsFor('reminder'); openEditModal('Edit Reminder');
    }

    function loadTasks(){
      const tasks = getTasks();
      const list = document.getElementById('taskList');
      list.innerHTML = '';
      const pmap = {'1':'!','2':'!!','3':'!!!'};
      tasks.forEach((t,i)=>{
        const li = document.createElement('li');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done;
        cb.addEventListener('change', ()=>{ const all=getTasks(); all[i].done = cb.checked; setTasks(all); updateProgress(all); updateDashboard(all); });
        const span = document.createElement('span'); span.innerHTML = ` ${escapeHTML(t.text)} ${t.date?`[${t.date}]`:''} ${t.time?`[${t.time}]`:''} Priority:${pmap[t.priority]||t.priority}`; span.className = `category-${t.category||''}`;
        const editBtn = document.createElement('button'); editBtn.className='small-btn'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=> editTask(i));
        const delBtn = document.createElement('button'); delBtn.className='small-btn'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=> deleteTask(i));
        li.appendChild(cb); li.appendChild(span); li.appendChild(editBtn); li.appendChild(delBtn);
        list.appendChild(li);
      });
      updateProgress(tasks); updateDashboard(tasks);
    }

    function addTask(){
      const text = document.getElementById('newTask').value.trim(); if (!text) return;
      const category = document.getElementById('taskCategory').value;
      const date = document.getElementById('taskDate').value || '';
      const time = document.getElementById('taskTime').value || '';
      const priority = document.getElementById('taskPriority').value || '2';
      const tasks = getTasks(); tasks.push({text,category,done:false,date,time,priority}); setTasks(tasks);
      document.getElementById('newTask').value=''; document.getElementById('taskDate').value=''; document.getElementById('taskTime').value=''; document.getElementById('taskPriority').value='1';
      loadTasks();
    }

    function deleteTask(i){ if(!confirm('Delete this task?')) return; const tasks=getTasks(); tasks.splice(i,1); setTasks(tasks); loadTasks(); }

    function editTask(i){
      const tasks=getTasks(); const t=tasks[i]; if(!t) return;
      document.getElementById('editKind').value='task';
      document.getElementById('editTaskIndex').value = i;
      document.getElementById('editText').value = t.text||'';
      document.getElementById('editDate').value = t.date||'';
      document.getElementById('editTime').value = t.time||'';
      document.getElementById('editCategory').value = t.category||'work';
      document.getElementById('editPriority').value = t.priority||'2';
      showModalFieldsFor('task'); openEditModal('Edit Task');
    }

    function updateProgress(tasks){
      const total = tasks.length;
      const done = tasks.filter(t=>t.done).length;
      const percent = total ? Math.round((done/total)*100) : 0;
      const ring = document.getElementById('progressRing');
      if (ring) { ring.style.borderTopColor = percent===100 ? 'limegreen' : '#4a90e2'; ring.title = percent + '% complete'; ring.style.transform = `rotate(${percent*3.6}deg)`; }
    }
    function updateDashboard(tasks){
      const total = tasks.length;
      const done = tasks.filter(t=>t.done).length;
      const categories = tasks.reduce((acc,t)=>{ acc[t.category]= (acc[t.category]||0)+1; return acc; },{});
      const summary = document.getElementById('summaryStats');
      if (summary) summary.innerHTML = `Total tasks: ${total}<br>Completed: ${done}<br>Work: ${categories.work||0}, Personal: ${categories.personal||0}, Errands: ${categories.errands||0}`;
    }

    function renderEvents(){
      const evs = getEvents();
      const list = document.getElementById('eventList');
      list.innerHTML = '';
      evs.forEach(e=>{
        const li = document.createElement('li');
        li.innerHTML = `${e.emoji?e.emoji+' ':''}<b>${escapeHTML(e.title)}</b> ‚Äî ${e.date} ${e.time?`[${e.time}]`:''} ${e.location?`@${escapeHTML(e.location)}`:''} <span class="item-controls"><button class="small-btn" onclick="editEvent(${e.id})">Edit</button><button class="small-btn" onclick="deleteEvent(${e.id})">Delete</button></span>`;
        list.appendChild(li);
      });
    }

    function addEvent(){
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      if (!title || !date) { alert('Event needs a title and date'); return; }
      const time = document.getElementById('eventTime').value || '';
      const location = document.getElementById('eventLocation').value.trim();
      const emoji = document.getElementById('eventEmoji').value.trim();
      const evs = getEvents();
      const id = evs.length ? Math.max(...evs.map(e=>e.id))+1 : 1;
      evs.push({id,title,date,time,location,emoji});
      setEvents(evs);
      document.getElementById('eventTitle').value=''; document.getElementById('eventDate').value=''; document.getElementById('eventTime').value=''; document.getElementById('eventLocation').value=''; document.getElementById('eventEmoji').value='';
      renderEvents(); generateCalendar();
    }

    function deleteEvent(id){ if(!confirm('Delete this event?')) return; let evs=getEvents(); evs = evs.filter(e=>e.id!==id); setEvents(evs); renderEvents(); generateCalendar(); if (selectedDay) showReminders(selectedDay); }

    function editEvent(id){
      const evs = getEvents(); const idx = evs.findIndex(e=>e.id===id); if (idx===-1) return;
      const e = evs[idx];
      document.getElementById('editKind').value='event';
      document.getElementById('editEventId').value = id;
      document.getElementById('editText').value = e.title || '';
      document.getElementById('editDate').value = e.date || '';
      document.getElementById('editTime').value = e.time || '';
      document.getElementById('editLocation').value = e.location || '';
      document.getElementById('editEmoji').value = e.emoji || '';
      showModalFieldsFor('event'); openEditModal('Edit Event');
    }

    function openEditModal(title){
      const m = document.getElementById('editModal'), h = document.getElementById('editModalHeading');
      if (h) h.textContent = title;
      if (m) m.style.display = 'flex';
    }
    function closeEditModal(){ const m = document.getElementById('editModal'); if (m) m.style.display = 'none'; }

    function showModalFieldsFor(kind){
      const loc = document.getElementById('editLocation'), emoji = document.getElementById('editEmoji'), category = document.getElementById('editCategory'), priority = document.getElementById('editPriority');
      if (!loc || !emoji || !category || !priority) return;
      if (kind==='event'){ loc.parentElement.style.display='block'; emoji.parentElement.style.display='block'; category.parentElement.style.display='none'; priority.parentElement.style.display='none'; }
      else if (kind==='task'){ loc.parentElement.style.display='none'; emoji.parentElement.style.display='none'; category.parentElement.style.display='block'; priority.parentElement.style.display='block'; }
      else { loc.parentElement.style.display='none'; emoji.parentElement.style.display='none'; category.parentElement.style.display='none'; priority.parentElement.style.display='none'; }
    }

    document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
    document.getElementById('editForm').addEventListener('submit', function(e){
      e.preventDefault();
      const kind = document.getElementById('editKind').value;
      const text = document.getElementById('editText').value.trim();
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value || '';
      if (kind==='event'){
        const id = parseInt(document.getElementById('editEventId').value,10);
        const evs = getEvents(); const idx = evs.findIndex(x=>x.id===id); if (idx===-1){ closeEditModal(); return; }
        evs[idx].title = text; evs[idx].date = date; evs[idx].time = time; evs[idx].location = document.getElementById('editLocation').value.trim(); evs[idx].emoji = document.getElementById('editEmoji').value.trim();
        setEvents(evs); renderEvents(); generateCalendar(); if (selectedDay) showReminders(selectedDay);
      } else if (kind==='task'){
        const idx = parseInt(document.getElementById('editTaskIndex').value,10);
        const tasks = getTasks(); if (!tasks[idx]) { closeEditModal(); return; }
        tasks[idx].text = text; tasks[idx].date = date; tasks[idx].time = time; tasks[idx].category = document.getElementById('editCategory').value; tasks[idx].priority = document.getElementById('editPriority').value;
        setTasks(tasks); loadTasks();
      } else if (kind==='reminder'){
        const origKey = document.getElementById('editReminderKey').value;
        const ridx = parseInt(document.getElementById('editReminderIndex').value,10);
        const r = getReminders(); const arr = r[origKey] || []; const item = arr[ridx]; if (!item){ closeEditModal(); return; }
        const newDate = date || origKey;
        arr.splice(ridx,1); if (!arr.length) delete r[origKey];
        if (!r[newDate]) r[newDate]=[];
        r[newDate].push({text,time});
        setReminders(r);
        const parts = newDate.split('-');
        if (parts.length===3){ selectedYear = parseInt(parts[0],10); selectedMonth = parseInt(parts[1],10)-1; selectedDay = parseInt(parts[2],10); }
        generateCalendar(); showReminders(selectedDay);
      }
      closeEditModal();
    });

    function escapeHTML(s){ return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    document.getElementById('prevBtn').addEventListener('click', ()=>{ selectedMonth--; if (selectedMonth<0){ selectedMonth=11; selectedYear--; } generateCalendar(); selectedDay = Math.min(selectedDay||1, new Date(selectedYear,selectedMonth+1,0).getDate()); showReminders(selectedDay); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ selectedMonth++; if (selectedMonth>11){ selectedMonth=0; selectedYear++; } generateCalendar(); selectedDay = Math.min(selectedDay||1, new Date(selectedYear,selectedMonth+1,0).getDate()); showReminders(selectedDay); });
    document.getElementById('addReminderBtn').addEventListener('click', addReminder);
    document.getElementById('addEventBtn').addEventListener('click', addEvent);
    document.getElementById('addTaskBtn').addEventListener('click', addTask);

    (function init(){
      try{
        const now = new Date();
        selectedMonth = now.getMonth();
        selectedYear = now.getFullYear();
        selectedDay = now.getDate();
        generateCalendar();
        showReminders(selectedDay);
        loadTasks();
        renderEvents();
      }catch(err){
        console.error('Init error',err);
        showAppError('Initialization error: ' + (err && err.message || err));
      }
    })();

    window.addEventListener('error', function(e){
      console.error('Runtime error', e.error||e.message);
      showAppError('App error: ' + (e.error ? e.error.message : e.message));
    });
  </script>
</body>
</html>
