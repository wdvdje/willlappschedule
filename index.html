<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimeScape Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f5f7fa;
      color: #333;
      text-align: center;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 1rem;
      font-size: 1.5rem;
    }
    .calendar-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px 0 0 0;
    }
    .calendar-controls button {
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-controls button:hover {
      background: #357abd;
    }
    .calendar-controls span {
      font-size: 1.25rem;
      min-width: 160px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    /* calendar uses the entire viewport width on desktop and mobile */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      padding: 10px;
      /* avoid using full 100vw which can produce horizontal overflow and hide content;
         use a small inset so the calendar is visible on all viewports */
      width: calc(100vw - 32px);
      max-width: 100%;
      margin: 0 auto 12px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.07);
      box-sizing: border-box;
      overflow-x: hidden;
    }
    .calendar-dayname {
      font-weight: bold;
      color: #4a90e2;
      padding-bottom: 4px;
      background: transparent;
      border: none;
      box-shadow: none;
      cursor: default;
    }
    .day {
      background: white;
      border-radius: 6px;
      padding: 10px 6px 6px 6px;
      min-height: 58px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.09);
      cursor: pointer;
      position: relative;
      transition: box-shadow 0.2s;
      overflow: hidden;
    }
    .day.today {
      outline: 2px solid #4a90e2;
    }
    /* remove fixed holiday background to allow dynamic month theme colors */
    .day.holiday {
      color: #c0392b;
      font-weight: bold;
    }
    .day.selected {
      box-shadow: 0 2px 7px 0 #4a90e250;
      border: 2px solid #4a90e2;
    }
    .day .reminder-dot {
      width: 8px; height: 8px;
      background: #e67e22;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      bottom: 8px;
      transform: translateX(-50%);
      display: inline-block;
    }
    .day .event-emoji {
      position: absolute;
      right: 6px;
      top: 6px;
      font-size: 1.1rem;
    }
    .tasks, .dashboard, .events, .reminders {
      margin: 20px;
      text-align: left;
      max-width: 540px;
      margin-left: auto;
      margin-right: auto;
    }
    .tasks h2, .dashboard h2, .events h2, .reminders h2 {
      margin-bottom: 10px;
    }
    /* remove bullets for lists but preserve indentation */
    .tasks ul, .events ul, .reminders ul, .reminder-bar ul, #taskList, #eventList {
      list-style: none;
      margin: 6px 0 0 18px;
      padding: 0;
    }
    /* mobile-only small labels for selects/date/time */
    .mobile-label { display: none; font-weight:600; margin-right:8px; min-width:64px; }
    .mobile-row { display:inline-flex; align-items:center; gap:8px; }
    @media (max-width: 600px) {
      .mobile-label { display:inline-block; }
      .mobile-row input, .mobile-row select { flex: 1 1 auto; }
    }
    .progress {
      margin: 20px auto;
      width: 120px; height: 120px;
      border-radius: 50%;
      border: 10px solid #ddd;
      border-top-color: #4a90e2;
      transition: transform 0.3s ease;
    }
    input[type="text"], select, input[type="date"], input[type="time"] {
      padding: 8px;
      width: 80%;
      margin-bottom: 10px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    button {
      padding: 8px 12px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .category-work { color: #e67e22; }
    .category-personal { color: #2ecc71; }
    .category-errands { color: #3498db; }
    .reminder-bar {
      background: #fbeee6;
      border-left: 4px solid #e67e22;
      color: #9a6b16;
      margin: 8px 0 0 0;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.96rem;
    }
    .item-controls { margin-left:8px; }
    .small-btn { padding:4px 6px; font-size:0.9rem; margin-left:6px; background:#888; }
    @media (max-width: 600px) {
      .calendar, .tasks, .dashboard, .reminders { max-width: 100vw; }
    }
    @media (max-width: 600px) {
      .calendar, .tasks, .dashboard, .events, .reminders {
        max-width: calc(100vw - 32px) !important;
        margin-left: auto !important;
        margin-right: auto !important;
        padding-left: 12px;
        padding-right: 12px;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <header>üìÖ TimeScape Planner</header>

  <div class="calendar-controls">
    <button onclick="prevMonth()">&lt;</button>
    <span id="monthLabel"></span>
    <button onclick="nextMonth()">&gt;</button>
  </div>
  <section class="calendar" id="calendar"></section>

  <!-- Reminders (grouped with other sections) -->
  <section class="reminders">
    <!-- date H2 goes above the static Reminders header; same size as the header -->
    <div id="reminderHeader">
      <h2 id="reminderDate" style="display:none; margin-bottom:6px;"></h2>
      <h2>‚è∞ Reminders</h2>
    </div>
    <!-- top bars (holiday + events) show directly under the date -->
    <div id="dayTopBars"></div>
    <div id="reminderBar"></div>
    <div style="margin-bottom:18px;" class="mobile-row">
      <label class="mobile-label" for="reminderInput">Reminder</label>
      <input type="text" id="reminderInput" placeholder="Add reminder to selected day..." />
      <label class="mobile-label" for="reminderTime" style="display:none;">Time</label>
    </div>
    <div style="margin-bottom:18px;" class="mobile-row">
      <label class="mobile-label" for="reminderTime">Time</label>
      <input type="time" id="reminderTime" style="width:18%; margin-left:6px;" />
      <button onclick="addReminder()">Add Reminder</button>
    </div>
  </section>

  <!-- Events -->
  <section class="events">
    <h2>üìÖ Events</h2>
    <input type="text" id="eventTitle" placeholder="Event title" />
    <div class="mobile-row">
      <label class="mobile-label" for="eventDate">Date</label>
      <input type="date" id="eventDate" />
      <label class="mobile-label" for="eventTime">Time</label>
      <input type="time" id="eventTime" />
    </div>
    <input type="text" id="eventLocation" placeholder="Location" />
    <input type="text" id="eventEmoji" placeholder="Emoji (e.g. üéâ)" style="width:20%" />
    <button onclick="addEvent()">Add Event</button>
    <ul id="eventList"></ul>
  </section>

  <!-- Tasks -->
  <section class="tasks">
    <h2>‚úÖ Tasks</h2>
    <input type="text" id="newTask" placeholder="Add a task..." />
    <select id="taskCategory">
      <option value="work">Work</option>
      <option value="personal">Personal</option>
      <option value="errands">Errands</option>
    </select>
    <div class="mobile-row" style="margin-top:6px;">
      <label class="mobile-label" for="taskDate">Date</label>
      <input type="date" id="taskDate" />
      <label class="mobile-label" for="taskTime">Time</label>
      <input type="time" id="taskTime" />
    </div>
    <div class="mobile-row" style="margin-top:6px;">
      <label class="mobile-label" for="taskPriority">Priority</label>
      <select id="taskPriority">
        <option value="1">!</option>
        <option value="2">!!</option>
        <option value="3">!!!</option>
      </select>
    </div>
    <button onclick="addTask()">Add</button>
    <ul id="taskList"></ul>
  </section>

  <!-- Dashboard -->
  <section class="dashboard">
    <h2>üìä Dashboard</h2>
    <p id="summaryStats"></p>
    <div class="progress" id="progressRing" title="0% complete"></div>
  </section>

  <script>
    // small visible error helper (appears under the header)
    function showAppError(msg) {
      let el = document.getElementById('appError');
      if (!el) {
        el = document.createElement('div');
        el.id = 'appError';
        el.style.background = '#ffecec';
        el.style.color = '#900';
        el.style.padding = '8px 12px';
        el.style.margin = '8px 16px';
        el.style.border = '1px solid #f5c6cb';
        el.style.borderRadius = '6px';
        el.style.textAlign = 'left';
        const header = document.querySelector('header') || document.body;
        header.insertAdjacentElement('afterend', el);
      }
      el.textContent = msg;
      console.warn('App message:', msg);
    }

    // Calendar state
    let selectedMonth, selectedYear, selectedDay = null;
    const calendar = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');
    const reminderBar = document.getElementById('reminderBar');
    const reminderInput = document.getElementById('reminderInput');
    const reminderTime = document.getElementById('reminderTime');

    // Month names
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    // Pastel themes per month
    const themes = [
      { weekday: '#cce5ff', weekend: '#e0ccff' }, // Jan
      { weekday: '#ffd6e0', weekend: '#e6ccff' }, // Feb
      { weekday: '#d6f5d6', weekend: '#cce0ff' }, // Mar
      { weekday: '#fff0b3', weekend: '#ffd9b3' }, // Apr
      { weekday: '#e6ffe6', weekend: '#ccf2ff' }, // May
      { weekday: '#ffe6cc', weekend: '#ffcccc' }, // Jun
      { weekday: '#fff5cc', weekend: '#ffd6cc' }, // Jul
      { weekday: '#e6f7ff', weekend: '#d9e6f2' }, // Aug
      { weekday: '#ffe6b3', weekend: '#ffccb3' }, // Sep
      { weekday: '#ffd9b3', weekend: '#e6ccb3' }, // Oct
      { weekday: '#e6f0ff', weekend: '#d6e6f5' }, // Nov
      { weekday: '#ffcccc', weekend: '#ccffcc' }  // Dec
    ];

    // Example holidays
    const holidays = {
      '01-01': { name: "New Year's Day", emoji: 'üéÜ' },
      '02-14': { name: "Valentine's Day", emoji: '‚ù§Ô∏è' },
      '03-17': { name: "St. Patrick's Day", emoji: 'üçÄ' },
      '04-01': { name: "April Fool's Day", emoji: 'ü§°' },
      '07-04': { name: "Independence Day", emoji: 'üéá' },
      '10-31': { name: "Halloween", emoji: 'üéÉ' },
      '12-25': { name: "Christmas Day", emoji: 'üéÖ' }
    };

    /* --- federal holiday helpers (adds Thanksgiving and other common US federal days) --- */
    function computeNthWeekday(year, monthIndex, weekday, n) {
      // n = 1..5 for nth occurrence. weekday 0=Sun..6=Sat
      const first = new Date(year, monthIndex, 1);
      const firstWeekday = first.getDay();
      let day = 1 + ((7 + weekday - firstWeekday) % 7) + (n-1)*7;
      return day;
    }
    function computeLastWeekday(year, monthIndex, weekday) {
      const last = new Date(year, monthIndex + 1, 0);
      const lastWeekday = last.getDay();
      let day = last.getDate() - ((7 + lastWeekday - weekday) % 7);
      return day;
    }
    function computeFederalHolidays(year) {
      // returns map 'MM-DD' -> {name, emoji}
      const map = {};
      // Martin Luther King Jr. Day (3rd Mon Jan)
      map['01-'+pad2(computeNthWeekday(year,0,1,3))] = { name: "Martin Luther King Jr. Day", emoji: '‚úä' };
      // Presidents' Day (3rd Mon Feb)
      map['02-'+pad2(computeNthWeekday(year,1,1,3))] = { name: "Presidents' Day", emoji: 'üèõÔ∏è' };
      // Memorial Day (last Mon May)
      map['05-'+pad2(computeLastWeekday(year,4,1))] = { name: "Memorial Day", emoji: 'üéóÔ∏è' };
      // Juneteenth (fixed)
      map['06-19'] = { name: "Juneteenth National Independence Day", emoji: 'üè≥Ô∏è‚Äçüåà' };
      // Independence, Veterans, Christmas, New Year are already present or fixed; add Labor Day (1st Mon Sep)
      map['09-'+pad2(computeNthWeekday(year,8,1,1))] = { name: "Labor Day", emoji: 'üõ†Ô∏è' };
      // Columbus Day (2nd Mon Oct)
      map['10-'+pad2(computeNthWeekday(year,9,1,2))] = { name: "Columbus Day", emoji: 'üß≠' };
      // Thanksgiving (4th Thu Nov)
      map['11-'+pad2(computeNthWeekday(year,10,4,4))] = { name: "Thanksgiving", emoji: 'ü¶É' };
      // Veterans Day (11-11)
      map['11-11'] = { name: "Veterans Day", emoji: 'üéñÔ∏è' };
      return map;
    }
    function getHoliday(mmdd, year) {
      // check static list first, then computed federal days for given year
      if (holidays[mmdd]) return holidays[mmdd];
      const computed = computeFederalHolidays(year);
      return computed[mmdd] || null;
    }
    /* --- end federal holiday helpers --- */

    function pad2(num) { return num < 10 ? '0' + num : '' + num; }

    // --- STORAGE HELPERS ---
    // small helper to safely parse localStorage values and recover from corrupted JSON
    function safeParseStorage(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (err) {
        console.warn('LocalStorage parse failed for', key, err);
        // remove the corrupted entry so future loads are clean
        try { localStorage.removeItem(key); } catch (e) {}
        return fallback;
      }
    }

    function getReminders() {
      // stored as { "YYYY-MM-DD": [ {text, time}, ... ] }
      return safeParseStorage('reminders', {});
    }
    function setReminders(data) { localStorage.setItem('reminders', JSON.stringify(data)); }

    function getTasks() { return safeParseStorage('tasks', []); }
    function setTasks(tasks) { localStorage.setItem('tasks', JSON.stringify(tasks)); }

    function getEvents() { return safeParseStorage('events', []); }
    function setEvents(ev) { localStorage.setItem('events', JSON.stringify(ev)); }

    // quick dev helper: run in the browser console to clear all app storage if needed:
    // (() => { localStorage.removeItem('events'); localStorage.removeItem('tasks'); localStorage.removeItem('reminders'); console.info('cleared app storage'); })();

    // --- REMINDERS ---
    function addReminder() {
      if (!selectedDay) { alert('Select a day in the calendar first!'); return; }
      const txt = reminderInput.value.trim();
      if (!txt) return;
      const time = reminderTime.value || '';
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(selectedDay)}`;
      const reminders = getReminders();
      if (!reminders[key]) reminders[key] = [];
      reminders[key].push({ text: txt, time });
      setReminders(reminders);
      reminderInput.value = '';
      reminderTime.value = '';
      showReminders(selectedDay);
      generateCalendar();
    }

    function editReminder(day, index) {
      const oldKey = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const reminders = getReminders();
      const item = reminders[oldKey][index];
      const newText = prompt('Edit reminder text:', item.text);
      if (newText === null) return;
      const newTime = prompt('Edit time (HH:MM, leave blank for none):', item.time || '');
      if (newTime === null) return;
      // allow moving to a different date
      const newDatePrompt = prompt('Date for this reminder (YYYY-MM-DD):', oldKey);
      if (newDatePrompt === null) return;
      const newDateKey = newDatePrompt.trim();
      // sanitize: if empty, keep old key
      const targetKey = newDateKey || oldKey;

      // remove from old location
      reminders[oldKey].splice(index,1);
      if (reminders[oldKey].length === 0) delete reminders[oldKey];
      // add to target location
      if (!reminders[targetKey]) reminders[targetKey] = [];
      reminders[targetKey].push({ text: newText.trim(), time: newTime.trim() });
      setReminders(reminders);

      // update UI: if the changed date is the currently selected, show it; otherwise clear selection
      if (targetKey === `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(selectedDay)}`) {
        showReminders(selectedDay);
      } else {
        // parse targetKey and update calendar selection
        const parts = targetKey.split('-');
        if (parts.length === 3) {
          const y = parseInt(parts[0],10);
          const m = parseInt(parts[1],10)-1;
          const d = parseInt(parts[2],10);
          selectedYear = y; selectedMonth = m; selectedDay = d;
        }
        generateCalendar();
        showReminders(selectedDay);
      }
    }

    function deleteReminder(day, index) {
      if (!confirm('Delete this reminder?')) return;
      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const reminders = getReminders();
      reminders[key].splice(index,1);
      if (reminders[key].length === 0) delete reminders[key];
      setReminders(reminders);
      showReminders(day);
      generateCalendar();
    }

    // small helper to produce a full readable date (e.g. "Tuesday, January 14, 2025")
    function formatFullDate(day, monthIndex, year) {
      const d = new Date(year, monthIndex, day);
      return d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function showReminders(day) {
      selectedDay = day;
      // Update selected UI
      [...calendar.children].forEach(cell => {
        if (cell.classList.contains('day')) {
          if (parseInt(cell.dataset.day) === day) cell.classList.add('selected');
          else cell.classList.remove('selected');
        }
      });

      const key = `${selectedYear}-${pad2(selectedMonth+1)}-${pad2(day)}`;
      const reminders = getReminders();
      const items = reminders[key] || [];
      const events = getEvents().filter(e => e.date === key);

      // put the formatted date into its H2 above the Reminders header
      const rd = document.getElementById('reminderDate');
      rd.textContent = formatFullDate(day, selectedMonth, selectedYear);
      rd.style.display = 'block';

      // Holiday info
      const keyMMDD = pad2(selectedMonth+1) + '-' + pad2(day);
      let holidayHTML = '';
      const h = getHoliday(keyMMDD, selectedYear);
      if (h) {
        holidayHTML = `
          <div class="reminder-bar" style="background:#ffe5e3;border-left:4px solid #c0392b;color:#c0392b;">
            <b>${h.emoji} ${h.name}</b>
          </div>
        `;
      }

      // Events (these go into the top bars under the date so edit/delete are visible there)
      let eventsHTML = '';
      if (events.length > 0) {
        eventsHTML = `
          <div class="reminder-bar" style="background:#eef6ff;border-left:4px solid #4a90e2;color:#234;">
            <b>Events:</b>
            <ul>
              ${events.map((ev, i) => `<li>${ev.time ? '['+ev.time+'] ' : ''}${ev.emoji ? ev.emoji+' ' : ''}<b>${escapeHTML(ev.title)}</b> ‚Äî ${escapeHTML(ev.location || '')}
                <span class="item-controls">
                  <button class="small-btn" onclick="editEvent(${ev.id})">Edit</button>
                  <button class="small-btn" onclick="deleteEvent(${ev.id})">Delete</button>
                </span>
              </li>`).join('')}
            </ul>
          </div>
        `;
      }

      // Reminders (kept separate below the top bars)
      let remindersHTML = '';
      if (items.length > 0) {
        remindersHTML = `
          <div class="reminder-bar">
            <b>Reminders for ${monthNames[selectedMonth]} ${day}, ${selectedYear}:</b>
            <ul>
              ${items.map((r, i) => `<li>${r.time ? '['+r.time+'] ' : ''}${escapeHTML(r.text)} 
                <span class="item-controls">
                  <button class="small-btn" onclick="editReminder(${day},${i})">Edit</button>
                  <button class="small-btn" onclick="deleteReminder(${day},${i})">Delete</button>
                </span>
              </li>`).join('')}
            </ul>
          </div>
        `;
      }

      // render top bars (holiday + events) directly under date, then render reminders below
      document.getElementById('dayTopBars').innerHTML = holidayHTML + eventsHTML;
      reminderBar.innerHTML = remindersHTML;
    }

    /* --- small-screen layout tweak: keep panels inset from screen edges --- */
    (function enhanceResponsiveStyles() {
      // Add an adjusted media rule so panels are not flush to the viewport edge on mobile.
      const css = `
        @media (max-width: 600px) {
          .calendar, .tasks, .dashboard, .events, .reminders {
            max-width: calc(100vw - 32px) !important;
            margin-left: auto !important;
            margin-right: auto !important;
            padding-left: 12px;
            padding-right: 12px;
            box-sizing: border-box;
          }
        }
      `;
      const s = document.createElement('style');
      s.appendChild(document.createTextNode(css));
      document.head.appendChild(s);
    })();

    // --- TASKS WITH DATE/TIME/PRIORITY ---
    const taskList = document.getElementById('taskList');
    const progressRing = document.getElementById('progressRing');
    const summaryStats = document.getElementById('summaryStats');

    function loadTasks() {
      const tasks = getTasks();
      taskList.innerHTML = '';
      const pmap = { '1': '!', '2': '!!', '3': '!!!' };
      tasks.forEach((task, index) => {
        const li = document.createElement('li');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = task.done;
        cb.onchange = () => {
          const all = getTasks();
          all[index].done = cb.checked;
          setTasks(all);
          updateProgress(all);
          updateDashboard(all);
        };
        const span = document.createElement('span');
        span.innerHTML = ` ${escapeHTML(task.text)} ${task.date ? '['+task.date+']' : ''} ${task.time ? '['+task.time+']' : ''} Priority:${pmap[task.priority] || task.priority}`;
        span.className = `category-${task.category}`;
        li.appendChild(cb);
        li.appendChild(span);

        const editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editTask(index);
        const delBtn = document.createElement('button');
        delBtn.className = 'small-btn';
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => deleteTask(index);
        li.appendChild(editBtn);
        li.appendChild(delBtn);

        taskList.appendChild(li);
      });
      updateProgress(tasks);
      updateDashboard(tasks);
    }

    function addTask() {
      const input = document.getElementById('newTask');
      const category = document.getElementById('taskCategory').value;
      const text = input.value.trim();
      const date = document.getElementById('taskDate').value || '';
      const time = document.getElementById('taskTime').value || '';
      const priority = document.getElementById('taskPriority').value || '2';
      if (!text) return;
      const tasks = getTasks();
      tasks.push({ text, category, done:false, date, time, priority });
      setTasks(tasks);
      input.value=''; document.getElementById('taskDate').value=''; document.getElementById('taskTime').value=''; document.getElementById('taskPriority').value='1';
      loadTasks();
    }

    function editTask(index) {
      const tasks = getTasks();
      const t = tasks[index];
      const newText = prompt('Edit task text:', t.text);
      if (newText === null) return;
      const newCategory = prompt('Category (work|personal|errands):', t.category || 'work');
      if (newCategory === null) return;
      const newDate = prompt('Date (YYYY-MM-DD) or empty:', t.date || '');
      if (newDate === null) return;
      const newTime = prompt('Time (HH:MM) or empty:', t.time || '');
      if (newTime === null) return;
      const newPriority = prompt('Priority (1-3):', t.priority || '2');
      if (newPriority === null) return;
      t.text = newText.trim();
      t.category = ['work','personal','errands'].includes(newCategory.trim()) ? newCategory.trim() : t.category;
      t.date = newDate.trim();
      t.time = newTime.trim();
      t.priority = ['1','2','3'].includes(newPriority) ? newPriority : '2';
      setTasks(tasks);
      loadTasks();
    }

    function deleteTask(index) {
      if (!confirm('Delete this task?')) return;
      const tasks = getTasks();
      tasks.splice(index,1);
      setTasks(tasks);
      loadTasks();
    }

    function updateProgress(tasks) {
      const total = tasks.length;
      const done = tasks.filter(t => t.done).length;
      const percent = total ? Math.round((done / total) * 100) : 0;
      progressRing.style.borderTopColor = percent === 100 ? "limegreen" : "#4a90e2";
      progressRing.title = percent + "% complete";
      progressRing.style.transform = `rotate(${percent * 3.6}deg)`;
    }

    function updateDashboard(tasks) {
      const total = tasks.length;
      const done = tasks.filter(t => t.done).length;
      const categories = tasks.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + 1; return acc; }, {});
      summaryStats.innerHTML = `Total tasks: ${total}<br>Completed: ${done}<br>Work: ${categories.work || 0}, Personal: ${categories.personal || 0}, Errands: ${categories.errands || 0}`;
    }

    // --- EVENTS ---
    const eventList = document.getElementById('eventList');
    function renderEvents() {
      const evs = getEvents();
      eventList.innerHTML = '';
      evs.forEach(e => {
        const li = document.createElement('li');
        li.innerHTML = `${e.emoji ? e.emoji+' ' : ''}<b>${escapeHTML(e.title)}</b> ‚Äî ${e.date} ${e.time ? '['+e.time+']' : ''} ${e.location ? ' @'+escapeHTML(e.location) : ''}
          <span class="item-controls">
            <button class="small-btn" onclick="editEvent(${e.id})">Edit</button>
            <button class="small-btn" onclick="deleteEvent(${e.id})">Delete</button>
          </span>`;
        eventList.appendChild(li);
      });
    }

    function addEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value || '';
      const location = document.getElementById('eventLocation').value.trim();
      const emoji = document.getElementById('eventEmoji').value.trim();
      if (!title || !date) { alert('Event needs a title and date'); return; }
      const evs = getEvents();
      const id = evs.length ? Math.max(...evs.map(e=>e.id)) + 1 : 1;
      evs.push({ id, title, date: date, time, location, emoji });
      setEvents(evs);
      document.getElementById('eventTitle').value=''; document.getElementById('eventDate').value=''; document.getElementById('eventTime').value=''; document.getElementById('eventLocation').value=''; document.getElementById('eventEmoji').value='';
      renderEvents();
      generateCalendar();
    }

    function editEvent(id) {
      const evs = getEvents();
      const idx = evs.findIndex(e=>e.id===id);
      if (idx === -1) return;
      const e = evs[idx];
      const title = prompt('Title:', e.title);
      if (title === null) return;
      const date = prompt('Date (YYYY-MM-DD):', e.date);
      if (date === null) return;
      const time = prompt('Time (HH:MM):', e.time || '');
      if (time === null) return;
      const location = prompt('Location:', e.location || '');
      if (location === null) return;
      const emoji = prompt('Emoji:', e.emoji || '');
      if (emoji === null) return;
      e.title = title.trim(); e.date = date.trim(); e.time = time.trim(); e.location = location.trim(); e.emoji = emoji.trim();
      setEvents(evs);
      renderEvents();
      generateCalendar();
      if (selectedDay) showReminders(selectedDay);
    }

    function deleteEvent(id) {
      if (!confirm('Delete this event?')) return;
      let evs = getEvents();
      evs = evs.filter(e=>e.id!==id);
      setEvents(evs);
      renderEvents();
      generateCalendar();
      if (selectedDay) showReminders(selectedDay);
    }

    // --- UTILITIES ---
    function escapeHTML(s) {
      return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // show errors early (helps if a runtime error prevented calendar from rendering)
    window.addEventListener('error', function (e) {
      console.error('Runtime error:', e.error || e.message);
      // non-intrusive visible hint for development
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.left = '12px';
      el.style.bottom = '12px';
      el.style.background = '#fdd';
      el.style.color = '#600';
      el.style.padding = '8px';
      el.style.border = '1px solid #c00';
      el.style.zIndex = 9999;
      el.textContent = 'App error: ' + (e.error ? e.error.message : e.message);
      document.body.appendChild(el);
    });

    // navigation helpers (restore prev/next buttons)
    function prevMonth() {
      selectedMonth--;
      if (selectedMonth < 0) { selectedMonth = 11; selectedYear--; }
      generateCalendar();
      // reset selectedDay to 1 for clarity, then show if valid
      selectedDay = Math.min(selectedDay || 1, new Date(selectedYear, selectedMonth + 1, 0).getDate());
      showReminders(selectedDay);
    }
    function nextMonth() {
      selectedMonth++;
      if (selectedMonth > 11) { selectedMonth = 0; selectedYear++; }
      generateCalendar();
      selectedDay = Math.min(selectedDay || 1, new Date(selectedYear, selectedMonth + 1, 0).getDate());
      showReminders(selectedDay);
    }

    // Init
    (function init() {
      const now = new Date();
      selectedMonth = now.getMonth();
      selectedYear = now.getFullYear();
      selectedDay = now.getDate();

      if (!calendar || !monthLabel) {
        showAppError('Initialization failed: missing DOM elements (calendar or month label).');
        return;
      }

      try {
        generateCalendar();
      } catch (err) {
        console.error('generateCalendar error', err);
        showAppError('Error generating calendar: ' + (err && err.message || err));
        return;
      }

      try {
        showReminders(selectedDay);
      } catch (err) {
        console.error('showReminders error', err);
        showAppError('Error showing reminders: ' + (err && err.message || err));
      }

      try {
        loadTasks();
      } catch (err) {
        console.error('loadTasks error', err);
        showAppError('Error loading tasks: ' + (err && err.message || err));
      }

      try {
        renderEvents();
      } catch (err) {
        console.error('renderEvents error', err);
        showAppError('Error rendering events: ' + (err && err.message || err));
      }
    })();
  </script>
</body>
</html>
